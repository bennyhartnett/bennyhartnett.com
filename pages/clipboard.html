<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

  body {
    font-family: 'Inter', sans-serif;
    color: white;
    margin: 0;
  }

  .clipboard-container {
    display: flex;
    flex-direction: row;
    justify-content: center;
    padding: 1rem;
    gap: 1.5rem;
  }

  /* Main panel - share section */
  .clipboard-main {
    flex: 1;
    max-width: 500px;
  }

  .clipboard-card {
    background: rgba(30, 30, 30, 0.8);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    padding: 1rem;
    width: 100%;
    box-sizing: border-box;
  }

  /* Sidebar - message history */
  .clipboard-sidebar {
    width: 350px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }

  .sidebar-card {
    background: rgba(30, 30, 30, 0.8);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
  }

  .sidebar-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .sidebar-header svg {
    width: 20px;
    height: 20px;
    color: #6366f1;
  }

  .sidebar-header h2 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
  }

  .sidebar-header .message-count {
    margin-left: auto;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    background: rgba(255, 255, 255, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
  }

  .sidebar-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.4);
    text-align: center;
    padding: 2rem;
  }

  .sidebar-empty svg {
    width: 48px;
    height: 48px;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .sidebar-empty p {
    margin: 0;
    font-size: 0.875rem;
  }

  .clipboard-header {
    text-align: center;
    margin-bottom: 0.75rem;
  }

  .clipboard-header h1 {
    font-size: 1.25rem;
    margin: 0 0 0.25rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .clipboard-header h1 svg {
    width: 22px;
    height: 22px;
    color: #6366f1;
  }

  .clipboard-header p {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
    margin: 0;
  }

  /* Room info */
  .room-info {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .room-info-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    white-space: nowrap;
  }

  .room-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    color: #6366f1;
    font-size: 0.875rem;
    font-weight: 600;
    font-family: inherit;
    min-width: 0;
  }

  .room-input:focus {
    outline: none;
    border-color: #6366f1;
  }

  .room-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
    font-weight: 400;
  }

  .btn-new-room {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    white-space: nowrap;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .btn svg {
    width: 16px;
    height: 16px;
  }

  .btn-primary {
    background: #6366f1;
    color: white;
  }

  .btn-primary:hover {
    background: #5558e3;
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  /* Status */
  .status-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 8px;
    font-size: 0.8rem;
    margin-bottom: 0.75rem;
  }

  .status-bar.waiting {
    background: rgba(251, 191, 36, 0.1);
    color: #fbbf24;
  }

  .status-bar.connected {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
  }

  .status-bar.error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
  }

  .status-bar.waiting .status-dot {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Share section */
  .share-section {
    display: none;
  }

  .share-section.active {
    display: block;
  }

  /* Text input with attachment */
  .input-wrapper {
    position: relative;
  }

  .text-input {
    width: 100%;
    min-height: 80px;
    padding: 0.75rem;
    padding-bottom: 2.5rem;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(0, 0, 0, 0.3);
    color: white;
    font-size: 0.875rem;
    font-family: inherit;
    resize: vertical;
    box-sizing: border-box;
  }

  .text-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .text-input:focus {
    outline: none;
    border-color: #6366f1;
  }

  .input-actions {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .attach-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .attach-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .attach-btn svg {
    width: 18px;
    height: 18px;
    color: rgba(255, 255, 255, 0.7);
  }

  .send-btn {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
  }

  .send-btn svg {
    width: 14px;
    height: 14px;
  }

  .file-input-hidden {
    display: none;
  }

  /* Received items in sidebar */
  .received-items {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    flex: 1;
    overflow-y: auto;
    min-height: 0;
  }

  .received-item {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .received-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .received-item-type {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .received-item-type svg {
    width: 14px;
    height: 14px;
  }

  .received-text {
    font-size: 0.875rem;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .received-image {
    max-width: 100%;
    border-radius: 4px;
  }

  .received-file {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .received-file-icon {
    width: 40px;
    height: 40px;
    background: rgba(99, 102, 241, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .received-file-icon svg {
    width: 20px;
    height: 20px;
    color: #6366f1;
  }

  .received-file-info {
    flex: 1;
    min-width: 0;
  }

  .received-file-name {
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .received-file-size {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .copy-btn, .download-btn, .preview-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
  }

  .file-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* Image preview modal */
  .preview-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .preview-modal.active {
    display: flex;
  }

  .preview-modal img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
  }

  .preview-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .preview-modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .preview-modal-close svg {
    width: 24px;
    height: 24px;
    color: white;
  }

  /* Transfer progress */
  .transfer-progress {
    display: none;
    margin-top: 1rem;
  }

  .transfer-progress.active {
    display: block;
  }

  .progress-bar {
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: #6366f1;
    border-radius: 2px;
    transition: width 0.2s ease;
    width: 0%;
  }

  .progress-text {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 0.5rem;
    text-align: center;
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Responsive: stack on mobile */
  @media (max-width: 900px) {
    .clipboard-container {
      flex-direction: column;
      align-items: stretch;
    }
    .clipboard-main {
      max-width: none;
    }
    .clipboard-sidebar {
      width: auto;
      max-height: 400px;
    }
  }

  @media (max-width: 600px) {
    .clipboard-container {
      padding: 1rem;
    }
    .clipboard-card, .sidebar-card {
      padding: 1rem;
    }
    .room-code {
      font-size: 1.5rem;
    }
  }
</style>

<div class="clipboard-container">
  <!-- Main panel - share section -->
  <div class="clipboard-main">
    <div class="clipboard-card">
      <div class="clipboard-header">
        <h1>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9.75a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
          </svg>
          Clipboard
        </h1>
        <p>Instant peer-to-peer sharing via WebRTC</p>
      </div>

      <div class="room-info">
        <div class="room-info-label">Room</div>
        <input type="text" class="room-input" id="roomInput" value="home" placeholder="Enter room code">
        <button class="btn btn-secondary btn-new-room" id="newRoomBtn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="14" height="14">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          New
        </button>
      </div>

      <div class="status-bar waiting" id="statusBar">
        <span class="status-dot"></span>
        <span id="statusText">Waiting for peer...</span>
      </div>

      <div class="share-section" id="shareSection">
        <div class="input-wrapper">
          <textarea class="text-input" id="textInput" placeholder="Type or paste text to share..."></textarea>
          <div class="input-actions">
            <button class="attach-btn" id="attachBtn" title="Attach file">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13" />
              </svg>
            </button>
            <button class="btn btn-primary send-btn" id="sendTextBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
              </svg>
              Send
            </button>
          </div>
          <input type="file" id="fileInput" class="file-input-hidden" multiple>
        </div>
        <div class="transfer-progress" id="transferProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">Sending...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar - message history -->
  <div class="clipboard-sidebar">
    <div class="sidebar-card">
      <div class="sidebar-header">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
        </svg>
        <h2>Messages</h2>
        <span class="message-count" id="messageCount">0</span>
      </div>
      <div class="sidebar-empty" id="sidebarEmpty">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
        </svg>
        <p>No messages yet</p>
        <p style="font-size: 0.75rem; margin-top: 0.5rem;">Messages from all devices will appear here</p>
      </div>
      <div class="received-items" id="receivedItems" style="display: none;"></div>
    </div>
  </div>
</div>

<!-- Preview modal -->
<div class="preview-modal" id="previewModal">
  <button class="preview-modal-close" id="previewModalClose">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
    </svg>
  </button>
  <img id="previewModalImg" src="" alt="Preview">
</div>

<script type="module">
  // Import Trystero for serverless WebRTC (mesh network)
  import { joinRoom } from 'https://esm.sh/trystero@0.20.0/torrent';

  // Elements
  const statusBar = document.getElementById('statusBar');
  const statusText = document.getElementById('statusText');
  const shareSection = document.getElementById('shareSection');
  const textInput = document.getElementById('textInput');
  const sendTextBtn = document.getElementById('sendTextBtn');
  const attachBtn = document.getElementById('attachBtn');
  const fileInput = document.getElementById('fileInput');
  const transferProgress = document.getElementById('transferProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const receivedItems = document.getElementById('receivedItems');
  const sidebarEmpty = document.getElementById('sidebarEmpty');
  const messageCount = document.getElementById('messageCount');
  const roomInput = document.getElementById('roomInput');
  const newRoomBtn = document.getElementById('newRoomBtn');
  const previewModal = document.getElementById('previewModal');
  const previewModalImg = document.getElementById('previewModalImg');
  const previewModalClose = document.getElementById('previewModalClose');

  // State
  const APP_ID = 'benny-clipboard-v1';
  let currentRoomCode = 'home';
  let room = null;
  let sendData = null;
  let sendHistory = null;
  const peers = new Set();
  const messageHistory = []; // Store all messages for late joiners

  // Get room code from URL path (e.g., clipboard.bennyhartnett.com/ghsk)
  function getRoomCodeFromUrl() {
    const path = location.pathname.replace(/^\/+|\/+$/g, ''); // Remove leading/trailing slashes
    return path || 'home';
  }

  // Generate random 4-character room code
  function generateRoomCode() {
    const chars = 'abcdefghijklmnopqrstuvwxyz';
    let code = '';
    for (let i = 0; i < 4; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // Update URL without reload
  function updateUrl(roomCode) {
    const newPath = roomCode === 'home' ? '/' : '/' + roomCode;
    history.pushState({ room: roomCode }, '', newPath);
  }

  // Switch to a different room
  function switchRoom(newRoomCode) {
    if (newRoomCode === currentRoomCode) return;

    // Clean up old room
    if (room) {
      room.leave();
      room = null;
      sendData = null;
      sendHistory = null;
      peers.clear();
      messageHistory.length = 0;
      receivedItems.innerHTML = '';
      updateSidebarUI();
    }

    // Update state
    currentRoomCode = newRoomCode;
    roomInput.value = newRoomCode;
    updateUrl(newRoomCode);

    // Join new room
    initRoom();
  }

  // Initialize Trystero room
  function initRoom() {
    setStatus('waiting', 'Connecting to room...');

    const ROOM_NAME = `benny-clipboard-${currentRoomCode}`;
    const config = { appId: APP_ID };
    room = joinRoom(config, ROOM_NAME);

    // Create action for sending/receiving clipboard data
    const [send, receive] = room.makeAction('clipboard');
    sendData = send;

    // Create action for syncing history to new peers
    const [sendHist, receiveHist] = room.makeAction('history');
    sendHistory = sendHist;

    // Handle receiving data from peers
    receive((data, peerId) => {
      // Add timestamp if not present
      if (!data.timestamp) {
        data.timestamp = Date.now();
      }
      // Store in history
      messageHistory.push(data);
      // Display it
      displayMessage(data);
    });

    // Handle receiving history sync from existing peers
    receiveHist((historyData, peerId) => {
      console.log('Received history from peer:', peerId, historyData.length, 'messages');
      // historyData is an array of messages
      for (const msg of historyData) {
        // Check if we already have this message (by timestamp)
        const exists = messageHistory.some(m => m.timestamp === msg.timestamp);
        if (!exists) {
          messageHistory.push(msg);
          displayMessage(msg, true); // append at end for history
        }
      }
      // Sort history display by timestamp (oldest at bottom)
      sortMessagesDisplay();
    });

    // Handle peer joining
    room.onPeerJoin(peerId => {
      console.log('Peer joined:', peerId);
      peers.add(peerId);
      updateStatus();

      // Send our message history to the new peer
      if (messageHistory.length > 0) {
        console.log('Sending history to new peer:', messageHistory.length, 'messages');
        sendHistory(messageHistory, peerId);
      }
    });

    // Handle peer leaving
    room.onPeerLeave(peerId => {
      console.log('Peer left:', peerId);
      peers.delete(peerId);
      updateStatus();
    });

    // Enable sharing immediately (can send even before peers connect)
    shareSection.classList.add('active');
    updateStatus();
  }

  // Update status based on peer count
  function updateStatus() {
    const count = peers.size;
    if (count === 0) {
      setStatus('waiting', 'Waiting for devices...');
    } else if (count === 1) {
      setStatus('connected', 'Connected to 1 device');
    } else {
      setStatus('connected', `Connected to ${count} devices`);
    }
  }

  // Set status
  function setStatus(type, text) {
    statusBar.className = 'status-bar ' + type;
    statusText.textContent = text;
  }

  // Update sidebar UI
  function updateSidebarUI() {
    const count = messageHistory.length;
    messageCount.textContent = count;

    if (count > 0) {
      sidebarEmpty.style.display = 'none';
      receivedItems.style.display = 'flex';
    } else {
      sidebarEmpty.style.display = 'flex';
      receivedItems.style.display = 'none';
    }
  }

  // Sort messages display by timestamp (newest first)
  function sortMessagesDisplay() {
    const items = Array.from(receivedItems.children);
    items.sort((a, b) => {
      const timeA = parseInt(a.dataset.timestamp) || 0;
      const timeB = parseInt(b.dataset.timestamp) || 0;
      return timeB - timeA; // newest first
    });
    items.forEach(item => receivedItems.appendChild(item));
  }

  // Display a message in the sidebar
  function displayMessage(data, appendAtEnd = false) {
    updateSidebarUI();

    const item = document.createElement('div');
    item.className = 'received-item';
    item.dataset.timestamp = data.timestamp || Date.now();

    const header = document.createElement('div');
    header.className = 'received-item-header';

    const typeEl = document.createElement('span');
    typeEl.className = 'received-item-type';

    const time = new Date(data.timestamp || Date.now()).toLocaleTimeString();

    if (data.type === 'text') {
      typeEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 0 1 .865-.501 48.172 48.172 0 0 0 3.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" /></svg> Text`;
      header.appendChild(typeEl);
      header.innerHTML += `<span>${time}</span>`;
      item.appendChild(header);

      const content = document.createElement('div');
      content.className = 'received-text';
      content.textContent = data.content;
      item.appendChild(content);

      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn btn-secondary copy-btn';
      copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9.75a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" /></svg> Copy';
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(data.content);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg> Copied!';
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9.75a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" /></svg> Copy';
        }, 2000);
      };
      item.appendChild(copyBtn);

    } else if (data.type === 'image') {
      typeEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg> Image`;
      header.appendChild(typeEl);
      header.innerHTML += `<span>${time}</span>`;
      item.appendChild(header);

      const img = document.createElement('img');
      img.className = 'received-image';
      img.src = data.content;
      item.appendChild(img);

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'file-actions';

      const previewBtn = document.createElement('button');
      previewBtn.className = 'btn btn-secondary preview-btn';
      previewBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg> Preview';
      previewBtn.onclick = () => showPreview(data.content);
      actionsDiv.appendChild(previewBtn);

      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn btn-secondary download-btn';
      downloadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg> Download';
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = data.content;
        a.download = data.name || 'image.png';
        a.click();
      };
      actionsDiv.appendChild(downloadBtn);

      item.appendChild(actionsDiv);

    } else if (data.type === 'file') {
      typeEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg> File`;
      header.appendChild(typeEl);
      header.innerHTML += `<span>${time}</span>`;
      item.appendChild(header);

      const fileDiv = document.createElement('div');
      fileDiv.className = 'received-file';

      const iconDiv = document.createElement('div');
      iconDiv.className = 'received-file-icon';
      iconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>';
      fileDiv.appendChild(iconDiv);

      const infoDiv = document.createElement('div');
      infoDiv.className = 'received-file-info';
      infoDiv.innerHTML = `<div class="received-file-name">${data.name}</div><div class="received-file-size">${formatFileSize(data.size)}</div>`;
      fileDiv.appendChild(infoDiv);

      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn btn-secondary download-btn';
      downloadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>';
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = data.content;
        a.download = data.name;
        a.click();
      };
      fileDiv.appendChild(downloadBtn);

      item.appendChild(fileDiv);
    }

    if (appendAtEnd) {
      receivedItems.appendChild(item);
    } else {
      receivedItems.insertBefore(item, receivedItems.firstChild);
    }
  }

  // Format file size
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // Send text
  function sendText() {
    const text = textInput.value.trim();
    if (!text || !sendData) return;

    const msg = { type: 'text', content: text, timestamp: Date.now() };
    sendData(msg);
    // Also store and display locally
    messageHistory.push(msg);
    displayMessage(msg);
    textInput.value = '';
  }

  // Send file
  function sendFile(file) {
    if (!sendData) return;

    const reader = new FileReader();
    reader.onload = () => {
      const isImage = file.type.startsWith('image/');
      const msg = {
        type: isImage ? 'image' : 'file',
        name: file.name,
        size: file.size,
        content: reader.result,
        timestamp: Date.now()
      };
      sendData(msg);
      // Also store and display locally
      messageHistory.push(msg);
      displayMessage(msg);
      transferProgress.classList.remove('active');
    };

    reader.onprogress = (e) => {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        progressFill.style.width = percent + '%';
        progressText.textContent = `Sending ${file.name}... ${Math.round(percent)}%`;
      }
    };

    transferProgress.classList.add('active');
    progressFill.style.width = '0%';
    progressText.textContent = `Reading ${file.name}...`;
    reader.readAsDataURL(file);
  }

  // Event listeners
  sendTextBtn.onclick = sendText;

  textInput.onkeydown = (e) => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      sendText();
    }
  };

  // Attachment button
  attachBtn.onclick = () => fileInput.click();

  fileInput.onchange = () => {
    Array.from(fileInput.files).forEach(sendFile);
    fileInput.value = '';
  };

  // Preview modal
  function showPreview(src) {
    previewModalImg.src = src;
    previewModal.classList.add('active');
  }

  previewModalClose.onclick = () => {
    previewModal.classList.remove('active');
  };

  previewModal.onclick = (e) => {
    if (e.target === previewModal) {
      previewModal.classList.remove('active');
    }
  };

  // Paste handling
  document.onpaste = (e) => {
    if (!sendData) return;

    const items = e.clipboardData.items;
    for (const item of items) {
      if (item.type.startsWith('image/')) {
        const file = item.getAsFile();
        sendFile(file);
      }
    }
  };

  // Room input - switch room on Enter
  roomInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const newRoom = roomInput.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
      if (newRoom) {
        switchRoom(newRoom);
      } else {
        roomInput.value = currentRoomCode;
      }
      roomInput.blur();
    }
  });

  // Room input - restore value on blur if empty
  roomInput.addEventListener('blur', () => {
    if (!roomInput.value.trim()) {
      roomInput.value = currentRoomCode;
    }
  });

  // New room button - generate and switch to new room
  newRoomBtn.addEventListener('click', () => {
    const newRoom = generateRoomCode();
    switchRoom(newRoom);
  });

  // Handle browser back/forward
  window.addEventListener('popstate', (e) => {
    const roomCode = e.state?.room || getRoomCodeFromUrl();
    if (roomCode !== currentRoomCode) {
      // Clean up old room
      if (room) {
        room.leave();
        room = null;
        sendData = null;
        sendHistory = null;
        peers.clear();
        messageHistory.length = 0;
        receivedItems.innerHTML = '';
        updateSidebarUI();
      }
      currentRoomCode = roomCode;
      roomInput.value = roomCode;
      initRoom();
    }
  });

  // Initialize with room from URL
  currentRoomCode = getRoomCodeFromUrl();
  roomInput.value = currentRoomCode;
  initRoom();
</script>
